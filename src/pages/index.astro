---
import Layout from '../components/Layout.astro';
import countries from '../data/countries.json';
import exitCodes from '../data/exitCodes.json';

const title = 'CodeToCall — International dialing made simple';
const description = 'Pick where you’re calling from and to, paste the number, and copy the exact international number to dial (tap-to-call on mobile).';

const countryOptions = [...countries].sort((a, b) => a.name.localeCompare(b.name));
---

<Layout title={title} description={description}>
  <h1 style="margin: 22px 0 8px;">Dial the right international number</h1>
  <p class="small" style="max-width: 75ch;">
    Choose a destination, then start typing the number. We’ll show the exact number to dial.
    On mobile you can tap to call; on desktop you can copy.
  </p>

  <div class="card" style="margin-top: 14px;">
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
      <div>
        <label for="to">Calling to</label>
        <select id="to" required>
          {countryOptions.map((c) => (
            <option value={c.iso2}>{c.name} ({c.iso2})</option>
          ))}
        </select>
        <div class="small" style="margin-top: 8px;">Destination local time will show below.</div>
      </div>

      <div>
        <label for="from">Calling from</label>
        <select id="from" required>
          {countryOptions.map((c) => (
            <option value={c.iso2}>{c.name} ({c.iso2})</option>
          ))}
        </select>
      </div>

      <div style="grid-column: 1 / -1;">
        <label for="num">Number to call</label>
        <input id="num" type="text" placeholder="e.g. +33 1 44 55 66 77, 07911 123 456, (0)20 7123 4567" />
        <div class="small" style="margin-top: 8px;">
          Tip: If you paste a number starting with <span class="kbd">+</span>, we’ll auto-detect the destination and update “Calling to”.
        </div>
      </div>
    </div>

    <div style="margin-top: 14px;" class="hero">
      <div class="small">Dial this</div>
      <div id="heroNumber" class="heroNumber">—</div>
      <div class="heroActions">
        <a id="callLink" class="btn primary" href="#" aria-disabled="true">Call now</a>
        <button type="button" id="copyBtn">Copy</button>
        <a class="small" href="/dial-builder/" style="margin-left:auto;">Advanced builder →</a>
      </div>
      <div id="heroMeta" class="small" style="margin-top: 10px;"></div>
      <div id="destTime" class="small" style="margin-top: 6px;"></div>
      <div id="warnings" class="small" style="margin-top: 10px;"></div>
    </div>
  </div>

  <div id="timeBand" class="band" aria-label="Destination local time" style="display:none;">
    <div class="bandTitle">Local time at destination</div>
    <div id="timeBandText" class="bandText small"></div>
  </div>

  <div class="adSlot adTop" aria-label="Advertisement placeholder">
    <div class="adLabel">Advertisement</div>
    <div class="adMeta">Top slot (e.g., 728×90 desktop / 320×100 mobile)</div>
  </div>

  <div class="grid" style="margin-top: 16px;">
    <div class="card">
      <h2 style="margin-top:0">Popular destinations</h2>
      <div class="tileRow" aria-label="Popular destinations">
        {countryOptions.slice(0, 10).map((c) => (
          <a class="tile" data-iso2={c.iso2} href={`/country/${c.iso2.toLowerCase()}/`}>
            <div class="tileTitle">{c.name}</div>
            <div class="tileSub">+{c.callingCode}</div>
          </a>
        ))}
      </div>
    </div>
    <div class="card">
      <h2 style="margin-top:0">Dialing tips</h2>
      <ul>
        <li>If the number starts with <span class="kbd">+</span>, you can usually dial it exactly as shown.</li>
        <li>If it starts with <span class="kbd">0</span>, you may need to drop the leading <span class="kbd">0</span> when calling internationally.</li>
        <li>Not sure? Use <a href="/dial-builder/">Advanced builder</a> for exit-code formats.</li>
      </ul>
    </div>
  </div>

  <div class="adSlot adMid" aria-label="Advertisement placeholder">
    <div class="adLabel">Advertisement</div>
    <div class="adMeta">Mid slot (e.g., responsive rectangle)</div>
  </div>

  <div class="adSlot adBottom" aria-label="Advertisement placeholder">
    <div class="adLabel">Advertisement</div>
    <div class="adMeta">Bottom slot (e.g., footer anchor / wide unit)</div>
  </div>

  <script type="application/json" id="data-countries" set:html={JSON.stringify(countries)} />
  <script type="application/json" id="data-exit" set:html={JSON.stringify(exitCodes)} />

  <script>
    const countries = JSON.parse(document.getElementById('data-countries').textContent);
    const byIso2 = new Map(countries.map(c => [c.iso2, c]));

    const $from = document.getElementById('from');
    const $to = document.getElementById('to');
    const $num = document.getElementById('num');

    const $heroNumber = document.getElementById('heroNumber');
    const $heroMeta = document.getElementById('heroMeta');
    const $warnings = document.getElementById('warnings');
    const $copyBtn = document.getElementById('copyBtn');
    const $callLink = document.getElementById('callLink');
    const $destTime = document.getElementById('destTime');
    const $timeBand = document.getElementById('timeBand');
    const $timeBandText = document.getElementById('timeBandText');

    const timeZonesByIso2 = {
      GB: 'Europe/London',
      US: 'America/New_York',
      CA: 'America/Toronto',
      IE: 'Europe/Dublin',
      FR: 'Europe/Paris',
      DE: 'Europe/Berlin',
      ES: 'Europe/Madrid',
      IT: 'Europe/Rome',
      AU: 'Australia/Sydney',
      IN: 'Asia/Kolkata'
    };

    function formatLocalTime(iso2) {
      const tz = timeZonesByIso2[iso2];
      if (!tz) return null;
      try {
        return new Intl.DateTimeFormat(undefined, {
          timeZone: tz,
          hour: '2-digit',
          minute: '2-digit',
        }).format(new Date());
      } catch {
        return null;
      }
    }

    function stripFormatting(input) {
      const trimmed = (input || '').trim();
      const hasPlus = trimmed.startsWith('+');
      const digitsOnly = trimmed.replace(/[^0-9]/g, '');
      return hasPlus ? `+${digitsOnly}` : digitsOnly;
    }

    function removeOptionalZeroMarker(input) {
      return (input || '').replace(/\(0\)/g, '');
    }

    function findCountryByCallingCodePrefix(digits) {
      const matches = countries
        .filter(c => digits.startsWith(c.callingCode))
        .sort((a, b) => b.callingCode.length - a.callingCode.length);
      return matches[0];
    }

    function setHero(e164, meta, warnings, destIso2) {
      $heroNumber.textContent = e164 || '—';
      $heroMeta.textContent = meta || '';

      const t = destIso2 ? formatLocalTime(destIso2) : null;
      const dest = destIso2 ? byIso2.get(destIso2) : null;

      $destTime.textContent = t ? `Local time there: ${t}` : '';

      if (t && dest) {
        $timeBand.style.display = '';
        $timeBandText.textContent = `${dest.name}: ${t}`;
      } else {
        $timeBand.style.display = 'none';
        $timeBandText.textContent = '';
      }

      $warnings.innerHTML = (warnings && warnings.length)
        ? '<ul>' + warnings.map(w => `<li>${w}</li>`).join('') + '</ul>'
        : '';

      const canCall = !!e164 && e164 !== '—';
      if (canCall) {
        $callLink.href = `tel:${e164}`;
        $callLink.setAttribute('aria-disabled', 'false');
        $callLink.classList.remove('disabled');
      } else {
        $callLink.href = '#';
        $callLink.setAttribute('aria-disabled', 'true');
        $callLink.classList.add('disabled');
      }

      $copyBtn.disabled = !canCall;
    }

    function normalizeForDestination(raw, destination) {
      const warnings = [];
      const raw0 = removeOptionalZeroMarker(raw);
      const stripped = stripFormatting(raw0);

      if (stripped.startsWith('+')) {
        const digits = stripped.slice(1);
        const c = findCountryByCallingCodePrefix(digits);
        if (!c) {
          warnings.push('This looks like an international number (+...), but the country code is not recognized in the current dataset.');
          return { e164: `+${digits}`, nsn: null, warnings, detectedDestIso2: null };
        }
        const nsn = digits.slice(c.callingCode.length);
        return { e164: `+${c.callingCode}${nsn}`, nsn, warnings, detectedDestIso2: c.iso2 };
      }

      let national = stripped;
      if (!national) {
        warnings.push('Enter a phone number.');
        return { e164: null, nsn: null, warnings, detectedDestIso2: null };
      }

      const trunk = destination.trunkPrefix;
      if (trunk && national.startsWith(trunk)) {
        national = national.slice(trunk.length);
        warnings.push(`Dropped leading trunk prefix “${trunk}” for international dialing.`);
      } else if (trunk && /^(0)+/.test(national)) {
        warnings.push('This number starts with 0. Many countries require dropping the leading 0 when calling internationally.');
      }

      return { e164: `+${destination.callingCode}${national}`, nsn: national, warnings, detectedDestIso2: null };
    }

    function setTileSelection(iso2) {
      document.querySelectorAll('.tileRow .tile').forEach((el) => {
        const v = (el.getAttribute('data-iso2') || '').toUpperCase();
        el.classList.toggle('selected', !!iso2 && v === iso2.toUpperCase());
      });
    }

    function update() {
      const origin = byIso2.get($from.value);
      const dest = byIso2.get($to.value);
      const raw = $num.value;

      setTileSelection(dest ? dest.iso2 : null);

      if (!origin || !dest) {
        setHero(null, '', ['Choose both “calling to” and “calling from”.'], null);
        return;
      }

      const { e164, warnings, detectedDestIso2 } = normalizeForDestination(raw, dest);

      // If user pasted a + number and we can detect the destination, keep UI in sync.
      if (detectedDestIso2 && byIso2.has(detectedDestIso2)) {
        $to.value = detectedDestIso2;
      }

      const finalDest = byIso2.get($to.value);
      const meta = finalDest
        ? `Destination: ${finalDest.name} (+${finalDest.callingCode})`
        : '';

      setHero(e164, meta, warnings, finalDest ? finalDest.iso2 : null);
    }

    async function copyText(text) {
      if (!text || text === '—') return;
      try {
        await navigator.clipboard.writeText(text);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    }

    async function copyWithFeedback() {
      const text = $heroNumber.textContent;
      if (!text || text === '—') return;

      await copyText(text);

      const prev = $copyBtn.textContent;
      $copyBtn.textContent = 'Copied ✓';
      $copyBtn.classList.add('success', 'flash');
      window.setTimeout(() => $copyBtn.classList.remove('flash'), 600);
      window.setTimeout(() => {
        $copyBtn.textContent = prev;
        $copyBtn.classList.remove('success');
      }, 1200);
    }

    document.getElementById('copyBtn').addEventListener('click', copyWithFeedback);

    $from.addEventListener('change', update);
    $to.addEventListener('change', update);
    $num.addEventListener('input', update);

    // Defaults for a useful first impression.
    $to.value = 'US';
    $from.value = 'GB';
    update();
  </script>
</Layout>
