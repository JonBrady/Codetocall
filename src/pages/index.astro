---
import Layout from '../components/Layout.astro';
import countries from '../data/countries.generated.json';
import exitCodes from '../data/exitCodes.json';

const title = 'CodeToCall — International dialing made simple';
const description = 'Pick where you’re calling from and to, paste the number, and copy the exact international number to dial (tap-to-call on mobile).';

const countryOptions = [...countries].sort((a, b) => a.name.localeCompare(b.name));
---

<Layout title={title} description={description}>
  <h1 style="margin: 22px 0 8px;">Dial the right international number</h1>
  <p class="small" style="margin-top:-2px;">Covering <strong>{countries.length}</strong> countries/territories.</p>
  <p class="small" style="max-width: 75ch;">
    Choose a destination, then start typing the number. We’ll show the exact number to dial.
    On mobile you can tap to call; on desktop you can copy.
  </p>

  <div class="card" style="margin-top: 14px;">
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
      <div>
        <label for="to">Calling to</label>
        <select id="to" required>
          {countryOptions.map((c) => (
            <option value={c.iso2}>{c.name} ({c.iso2})</option>
          ))}
        </select>
        <div class="small" style="margin-top: 8px;">Destination local time will show below.</div>
      </div>

      <div>
        <label for="from">Calling from</label>
        <select id="from" required>
          {countryOptions.map((c) => (
            <option value={c.iso2}>{c.name} ({c.iso2})</option>
          ))}
        </select>
      </div>

      <div style="grid-column: 1 / -1;">
        <label for="num">Please enter the number you want to call</label>
        <input id="num" type="text" placeholder="e.g. +33 1 44 55 66 77, 07911 123 456, (0)20 7123 4567" />
        <div class="small" style="margin-top: 8px;">
          Tip: If you paste a number starting with <span class="kbd">+</span>, we’ll auto-detect the destination and update “Calling to”.
        </div>
      </div>
    </div>

    <div style="margin-top: 14px;" class="hero" id="hero">
      <div class="small">Dial this</div>
      <div class="heroNumberWrap">
        <div id="heroNumber" class="heroNumber">—</div>
        <div id="heroHint" class="heroHint" aria-hidden="true">
          <div class="heroHintInner">
            <div class="heroHintTrack">
              <span>Enter the number you want to call in the text box above.</span>
              <span aria-hidden="true">Enter the number you want to call in the text box above.</span>
            </div>
          </div>
        </div>
      </div>
      <div class="heroActions">
        <a id="callLink" class="btn primary" href="#" aria-disabled="true">Call now</a>
        <button type="button" id="copyBtn">Copy</button>
        <a id="advancedLink" class="btn adv" href="/dial-builder/" style="margin-left:auto;">Advanced builder →</a>
      </div>
      <div id="heroMeta" class="small" style="margin-top: 10px;"></div>
      <div id="heroContext" class="small" style="margin-top: 4px;"></div>
      <div id="altDial" class="small" style="margin-top: 6px;"></div>
      <div id="localDial" class="small" style="margin-top: 6px;"></div>
      <div id="warnings" class="small" style="margin-top: 10px;"></div>
    </div>
  </div>

  <div id="timeBand" class="band" aria-label="Destination local time" style="display:none;">
    <div class="bandTitle">Local time at destination</div>
    <div id="timeBandText" class="bandText small"></div>
    <div id="tzWrap" class="bandText small" style="margin-top:6px; display:none;"></div>
  </div>


  <div class="grid" style="margin-top: 16px;">
    <div class="card">
      <h2 style="margin-top:0">Popular destinations</h2>
      <p class="small" style="margin-top:-6px;">Or browse by calling code: try <a href="/calling-code/1/">+1</a>, <a href="/calling-code/44/">+44</a>, <a href="/calling-code/61/">+61</a>.</p>
      <div class="tileRow" aria-label="Popular destinations">
        {(() => {
          const POPULAR = ['US','FR','ES','DE','IE','IT','NL','AU','IN','PK'];
          const picked = POPULAR
            .map((iso2) => countryOptions.find((c) => c.iso2 === iso2))
            .filter(Boolean);

          return picked.map((c) => (
            <a class="tile" data-iso2={c.iso2} href={`/country/${c.iso2.toLowerCase()}/`}>
              <div class="tileTitle">{c.name}</div>
              <div class="tileSub">+{c.callingCode}</div>
            </a>
          ));
        })()}
      </div>
    </div>
    <div class="card">
      <h2 style="margin-top:0">Dialing tips</h2>
      <ul>
        <li>If the number starts with <span class="kbd">+</span>, you can usually dial it exactly as shown.</li>
        <li>If it starts with <span class="kbd">0</span>, you may need to drop the leading <span class="kbd">0</span> when calling internationally.</li>
        <li>Not sure? Use <a href="/dial-builder/">Advanced builder</a> for exit-code formats.</li>
      </ul>
    </div>
  </div>


  <script type="application/json" id="data-countries" set:html={JSON.stringify(countries)} />
  <script type="application/json" id="data-exit" set:html={JSON.stringify(exitCodes)} />

  <!-- libphonenumber-js (client-side) for correct E.164 formatting when user types national numbers -->
  <script type="module">
    import { parsePhoneNumberFromString } from 'libphonenumber-js';
    window.libphonenumber = { parsePhoneNumberFromString };
  </script>

  <script>
    const countries = JSON.parse(document.getElementById('data-countries').textContent);
    const exitCodes = JSON.parse(document.getElementById('data-exit').textContent);
    const byIso2 = new Map(countries.map(c => [c.iso2, c]));

    const $from = document.getElementById('from');
    const $to = document.getElementById('to');
    const $num = document.getElementById('num');

    const $heroNumber = document.getElementById('heroNumber');
    const $heroMeta = document.getElementById('heroMeta');
    const $warnings = document.getElementById('warnings');
    const $heroHint = document.getElementById('heroHint');
    const $hero = document.getElementById('hero');
    const $heroContext = document.getElementById('heroContext');
    const $copyBtn = document.getElementById('copyBtn');
    const $callLink = document.getElementById('callLink');
    const $altDial = document.getElementById('altDial');
    const $localDial = document.getElementById('localDial');
    const $timeBand = document.getElementById('timeBand');
    const $timeBandText = document.getElementById('timeBandText');
    const $tzWrap = document.getElementById('tzWrap');

    const timeZonesByIso2 = {
      GB: [{ id: 'Europe/London', label: 'UK (London)' }],
      IE: [{ id: 'Europe/Dublin', label: 'Ireland (Dublin)' }],
      FR: [{ id: 'Europe/Paris', label: 'France (Paris)' }],
      DE: [{ id: 'Europe/Berlin', label: 'Germany (Berlin)' }],
      ES: [{ id: 'Europe/Madrid', label: 'Spain (Madrid)' }],
      IT: [{ id: 'Europe/Rome', label: 'Italy (Rome)' }],
      IN: [{ id: 'Asia/Kolkata', label: 'India (Kolkata)' }],

      // Multi-timezone countries: offer a minimal selector.
      US: [
        { id: 'America/New_York', label: 'US — Eastern' },
        { id: 'America/Chicago', label: 'US — Central' },
        { id: 'America/Denver', label: 'US — Mountain' },
        { id: 'America/Los_Angeles', label: 'US — Pacific' },
      ],
      CA: [
        { id: 'America/Toronto', label: 'Canada — Eastern' },
        { id: 'America/Winnipeg', label: 'Canada — Central' },
        { id: 'America/Edmonton', label: 'Canada — Mountain' },
        { id: 'America/Vancouver', label: 'Canada — Pacific' },
      ],
      AU: [
        { id: 'Australia/Sydney', label: 'Australia — Sydney' },
        { id: 'Australia/Brisbane', label: 'Australia — Brisbane' },
        { id: 'Australia/Adelaide', label: 'Australia — Adelaide' },
        { id: 'Australia/Perth', label: 'Australia — Perth' },
      ],
    };

    function formatLocalTime(tzId) {
      if (!tzId) return null;
      try {
        return new Intl.DateTimeFormat(undefined, {
          timeZone: tzId,
          hour: '2-digit',
          minute: '2-digit',
        }).format(new Date());
      } catch {
        return null;
      }
    }

    let activeDestIso2 = null;
    let activeTzId = null;
    let tickTimer = null;

    function startTicker() {
      if (tickTimer) window.clearInterval(tickTimer);
      tickTimer = window.setInterval(() => {
        // Re-render the displayed time every minute.
        if (!activeDestIso2 || !activeTzId) return;
        const t = formatLocalTime(activeTzId);
        const dest = byIso2.get(activeDestIso2);
        if (!t || !dest) return;
        $timeBand.style.display = '';
        $timeBandText.textContent = `${dest.name}: ${t}`;
      }, 60_000);
    }

    function stripFormatting(input) {
      const trimmed = (input || '').trim();
      const hasPlus = trimmed.startsWith('+');
      const digitsOnly = trimmed.replace(/[^0-9]/g, '');
      return hasPlus ? `+${digitsOnly}` : digitsOnly;
    }

    function removeOptionalZeroMarker(input) {
      return (input || '').replace(/\(0\)/g, '');
    }

    function findCountryByCallingCodePrefix(digits) {
      const matches = countries
        .filter(c => digits.startsWith(c.callingCode))
        .sort((a, b) => b.callingCode.length - a.callingCode.length);
      return matches[0];
    }

    function renderTimeUI(destIso2) {
      const dest = destIso2 ? byIso2.get(destIso2) : null;
      const tzList = destIso2 ? (timeZonesByIso2[destIso2] || []) : [];

      activeDestIso2 = destIso2 || null;

      if (!dest || !tzList.length) {
        activeTzId = null;
        $destTime.textContent = '';
        $timeBand.style.display = 'none';
        $timeBandText.textContent = '';
        $tzWrap.style.display = 'none';
        $tzWrap.innerHTML = '';
        return;
      }

      // Keep previously selected tz if still applicable, otherwise choose the first (default).
      if (!activeTzId || !tzList.some(z => z.id === activeTzId)) {
        activeTzId = tzList[0].id;
      }

      const t = formatLocalTime(activeTzId);

      if (t) {
        $timeBand.style.display = '';
        $timeBandText.textContent = `${dest.name}: ${t}`;
      } else {
        $timeBand.style.display = 'none';
        $timeBandText.textContent = '';
      }

      // Show selector only when there are multiple zones.
      if (tzList.length > 1) {
        $tzWrap.style.display = '';
        $tzWrap.innerHTML = `Time zone: <select id="tzSelect"></select>`;
        const sel = document.getElementById('tzSelect');
        tzList.forEach(z => {
          const opt = document.createElement('option');
          opt.value = z.id;
          opt.textContent = z.label;
          sel.appendChild(opt);
        });
        sel.value = activeTzId;
        sel.addEventListener('change', () => {
          activeTzId = sel.value;
          renderTimeUI(activeDestIso2);
          syncUrl();
        });
      } else {
        $tzWrap.style.display = 'none';
        $tzWrap.innerHTML = '';
      }

      startTicker();
    }

    function setHero(e164, meta, warnings, destIso2, altDialText, localDialText, contextText) {
      $heroNumber.textContent = e164 || '';
      $heroMeta.textContent = meta || '';
      $altDial.textContent = altDialText || '';
      $localDial.textContent = localDialText || '';

      renderTimeUI(destIso2);

      $warnings.innerHTML = (warnings && warnings.length)
        ? '<ul>' + warnings.map(w => `<li>${w}</li>`).join('') + '</ul>'
        : '';

      if ($heroContext) {
        $heroContext.textContent = contextText || '';
      }

      const canCall = !!e164;
      if (canCall) {
        $callLink.href = `tel:${e164}`;
        $callLink.setAttribute('aria-disabled', 'false');
        $callLink.classList.remove('disabled');
      } else {
        $callLink.href = '#';
        $callLink.setAttribute('aria-disabled', 'true');
        $callLink.classList.add('disabled');
      }

      $copyBtn.disabled = !canCall;

      // Show a subtle marquee hint when nothing has been entered yet.
      if ($heroHint) {
        $heroHint.style.display = canCall ? 'none' : 'flex';
        $heroHint.setAttribute('aria-hidden', canCall ? 'true' : 'false');
      }

      // Hide buttons until there is a valid number (prevents overlap + makes the hero calmer).
      if ($hero) {
        $hero.classList.toggle('hasNumber', canCall);
      }
    }

    function normalizeForDestination(raw, destination) {
      const warnings = [];
      const raw0 = removeOptionalZeroMarker(raw);
      const stripped = stripFormatting(raw0);

      // If we have a destination context and the user did NOT paste a + number,
      // try to parse/format with libphonenumber for correct trunk-prefix handling.
      // This prevents bugs like +440... when dialing UK mobiles.
      try {
        if (destination?.iso2 && stripped && !stripped.startsWith('+') && window.libphonenumber?.parsePhoneNumberFromString) {
          const pn = window.libphonenumber.parsePhoneNumberFromString(stripped, destination.iso2);
          if (pn && pn.isValid && pn.isValid()) {
            return { e164: pn.number, nsn: pn.nationalNumber, warnings, detectedDestIso2: null };
          }
        }
      } catch {
        // fall through to heuristic logic
      }

      // Basic sanity checks (formatting only; we cannot verify if a number is active)
      const digitsForLen = stripped.startsWith('+') ? stripped.slice(1) : stripped;
      if (digitsForLen && digitsForLen.length < 6) {
        warnings.push('This looks very short for a phone number. Double-check you’ve entered the full number (including area code).');
      }
      if (digitsForLen && digitsForLen.length > 15) {
        warnings.push('This looks very long for a phone number. Double-check for extra digits.');
      }

      if (stripped.startsWith('+')) {
        const digits = stripped.slice(1);
        const c = findCountryByCallingCodePrefix(digits);
        if (!c) {
          warnings.push('This looks like an international number (+...), but the country code is not recognized in the current dataset.');
          return { e164: `+${digits}`, nsn: null, warnings, detectedDestIso2: null };
        }
        const nsn = digits.slice(c.callingCode.length);
        return { e164: `+${c.callingCode}${nsn}`, nsn, warnings, detectedDestIso2: c.iso2 };
      }

      let national = stripped;
      if (!national) {
        warnings.push('Enter a phone number.');
        return { e164: null, nsn: null, warnings, detectedDestIso2: null };
      }

      const trunk = destination.trunkPrefix;
      if (trunk && national.startsWith(trunk)) {
        national = national.slice(trunk.length);
        warnings.push(`Dropped leading trunk prefix “${trunk}” for international dialing.`);
      } else if (!trunk && /^0+/.test(national)) {
        // Heuristic: most countries use a leading 0 as a national trunk prefix.
        // When building an international E.164 number, drop it.
        national = national.replace(/^0+/, '');
        warnings.push('Dropped leading 0 trunk prefix for international dialing.');
      } else if (!trunk && /^00/.test(national)) {
        warnings.push('This number starts with 00 (an international dialing prefix). Consider pasting the number with a leading + instead.');
      }

      return { e164: `+${destination.callingCode}${national}`, nsn: national, warnings, detectedDestIso2: null };
    }

    function setTileSelection(iso2) {
      document.querySelectorAll('.tileRow .tile').forEach((el) => {
        const v = (el.getAttribute('data-iso2') || '').toUpperCase();
        el.classList.toggle('selected', !!iso2 && v === iso2.toUpperCase());
      });
    }

    function update() {
      const origin = byIso2.get($from.value);
      const dest = byIso2.get($to.value);
      const raw = $num.value;

      setTileSelection(dest ? dest.iso2 : null);

      if (!origin || !dest) {
        setHero(null, '', ['Choose both “calling to” and “calling from”.'], null, '', '', '');
        return;
      }

      const { e164, nsn, warnings, detectedDestIso2 } = normalizeForDestination(raw, dest);

      // If user pasted a + number and we can detect the destination, keep UI in sync.
      if (detectedDestIso2 && byIso2.has(detectedDestIso2)) {
        $to.value = detectedDestIso2;
      }

      syncUrl();

      const finalDest = byIso2.get($to.value);

      // Build a “landline / older phone” dial string using the origin exit code (IDD prefix), if available.
      const exit = exitCodes[origin.iso2];
      const legacy = exit && nsn && finalDest ? `${exit} ${finalDest.callingCode} ${nsn}` : null;

      const alt = legacy
        ? `If you can’t dial “+”, try: ${legacy}`
        : 'On most mobiles, you can dial the number exactly as shown (with “+”).';

      // Same-country hint
      const isInternationalInput = stripFormatting(removeOptionalZeroMarker(raw)).startsWith('+');
      let localLine = '';
      if (origin.iso2 === finalDest?.iso2 && nsn && !isInternationalInput) {
        const trunk = finalDest.trunkPrefix;
        const local = trunk ? `${trunk}${nsn}` : nsn;
        localLine = `Calling within ${finalDest.name}? You may be able to dial locally as: ${local}`;
      }

      const meta = finalDest
        ? `Destination: ${finalDest.name} (+${finalDest.callingCode})`
        : '';

      const contextText = (raw && raw.trim() && !stripFormatting(removeOptionalZeroMarker(raw)).startsWith('+'))
        ? `Interpreting as a ${finalDest.name} national number.`
        : '';

      setHero(e164, meta, warnings, finalDest ? finalDest.iso2 : null, alt, localLine, contextText);
    }

    async function copyText(text) {
      if (!text || text === '—') return;
      try {
        await navigator.clipboard.writeText(text);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    }

    async function copyWithFeedback() {
      const text = $heroNumber.textContent;
      if (!text || text === '—') return;

      await copyText(text);

      const prev = $copyBtn.textContent;
      $copyBtn.textContent = 'Copied ✓';
      $copyBtn.classList.add('success', 'flash');
      window.setTimeout(() => $copyBtn.classList.remove('flash'), 600);
      window.setTimeout(() => {
        $copyBtn.textContent = prev;
        $copyBtn.classList.remove('success');
      }, 1200);
    }

    document.getElementById('copyBtn').addEventListener('click', copyWithFeedback);

    $from.addEventListener('change', update);
    $to.addEventListener('change', update);
    $num.addEventListener('input', update);

    const $brandHome = document.getElementById('brandHome');
    const $advancedLink = document.getElementById('advancedLink');

    const STATE_KEY = 'codetocall_home_state_v1';

    function persistState() {
      try {
        localStorage.setItem(STATE_KEY, JSON.stringify({
          from: $from.value,
          to: $to.value,
          num: $num.value,
          tz: activeTzId || ''
        }));
      } catch {}
    }

    function syncUrl() {
      const url = new URL(window.location.href);
      url.searchParams.set('from', $from.value);
      url.searchParams.set('to', $to.value);
      if ($num.value && $num.value.trim()) url.searchParams.set('num', $num.value);
      else url.searchParams.delete('num');
      if (activeTzId) url.searchParams.set('tz', activeTzId);
      else url.searchParams.delete('tz');
      history.replaceState({}, '', url);

      persistState();

      // Keep the logo/home link preserving state
      if ($brandHome) $brandHome.href = `/?${url.searchParams.toString()}`;

      // Keep the advanced builder link pre-filled
      const adv = new URL('/dial-builder/', window.location.origin);
      adv.searchParams.set('from', $from.value);
      adv.searchParams.set('to', $to.value);
      if ($num.value && $num.value.trim()) adv.searchParams.set('num', $num.value);
      if ($advancedLink) $advancedLink.href = adv.pathname + '?' + adv.searchParams.toString();
    }

    // Restore from query params (or localStorage fallback)
    const q = new URLSearchParams(window.location.search);
    const qFrom = (q.get('from') || '').toUpperCase();
    const qTo = (q.get('to') || '').toUpperCase();
    const qNum = q.get('num') || '';
    const qTz = q.get('tz') || '';

    let stored = null;
    try { stored = JSON.parse(localStorage.getItem(STATE_KEY) || 'null'); } catch {}

    // Defaults for a useful first impression.
    const from = byIso2.has(qFrom) ? qFrom : (byIso2.has((stored?.from||'').toUpperCase()) ? (stored.from||'').toUpperCase() : 'GB');
    const to = byIso2.has(qTo) ? qTo : (byIso2.has((stored?.to||'').toUpperCase()) ? (stored.to||'').toUpperCase() : 'US');
    $from.value = from;
    $to.value = to;

    const initialNum = qNum || (stored?.num || '');
    if (initialNum) $num.value = initialNum;

    const initialTz = qTz || (stored?.tz || '');
    if (initialTz) activeTzId = initialTz;

    update();
    syncUrl();

    // Keep URL in sync while typing/choosing.
    $from.addEventListener('change', syncUrl);
    $to.addEventListener('change', syncUrl);
    $num.addEventListener('input', syncUrl);

  </script>
</Layout>
